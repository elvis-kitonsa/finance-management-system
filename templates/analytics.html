{% extends "base.html" %} {% block content %}

<header class="top-nav d-flex justify-content-between align-items-center">
  <h5 class="fw-bold mb-0">FinanceFlow | Analytics</h5>
  <div class="d-flex align-items-center gap-3">
    <div class="text-end d-none d-md-block">
      <small class="text-muted d-block" id="current-day">{{ current_day }}</small>
      <span class="fw-bold small" id="current-date">{{ current_date }}</span>
    </div>
    <div class="vr mx-2"></div>

    <div class="dropdown">
      <a href="#" class="user-avatar dropdown-toggle shadow-sm text-decoration-none" id="profileDropdown" data-bs-toggle="dropdown" aria-expanded="false">
        <span id="user-initials">{{ initials }}</span>
      </a>
      <ul class="dropdown-menu dropdown-menu-end shadow border-0" aria-labelledby="profileDropdown" style="border-radius: 20px; padding: 10px">
        <li class="px-3 py-3 border-bottom">
          <p class="mb-0 small text-muted">Signed in as</p>
          <p class="mb-0 fw-bold">{{ current_user.full_name }}</p>
          <p class="mb-0 small text-muted user-email-text">{{ current_user.email }}</p>
        </li>
        <li>
          <a class="dropdown-item mt-2" href="#"><i class="bi bi-person me-2"></i> Your Profile</a>
        </li>
        <li>
          <a class="dropdown-item" href="#"><i class="bi bi-wallet2 me-2"></i> Your Accounts</a>
        </li>
        <li>
          <a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i> Settings</a>
        </li>
        <li><hr class="dropdown-divider" /></li>
        <li>
          <a class="dropdown-item text-danger" href="{{ url_for('logout') }}"><i class="bi bi-box-arrow-right me-2"></i> Sign out</a>
        </li>
      </ul>
    </div>
  </div>
</header>

<main class="p-4">
  <div class="row g-4">
    <div class="col-xl-8">
      <div class="card glass-card h-100 border-0 shadow-sm">
        <div class="p-4">
          <h5 class="fw-bold">Burn Rate (Cumulative Spend)</h5>
          <br />
          <div style="height: 350px; position: relative">
            <canvas id="burnRateChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-4">
      <div class="card glass-card border-0 p-4 mb-4 shadow text-white" 
        style="border-radius: 24px; background-color: #0000ff !important; box-shadow: 0 10px 30px rgba(0, 0, 255, 0.3) !important;">
        <small class="text-white text-uppercase fw-bold" style="letter-spacing: 0.5px;">Projected Runway</small>
        <h2 class="fw-bold mb-0 text-dark">{{ days_left }} Days</h2>
        <p class="mb-0 small text-white">Until capital hits UGX 0</p>
    </div>

      <div class="card glass-card border-0 p-4 shadow-sm" style="border-radius: 24px">
        <div class="d-flex align-items-center gap-3">
          <div class="icon-box bg-danger-subtle text-danger rounded-circle p-3" data-bs-toggle="modal" data-bs-target="#burnRateInfoModal" style="cursor: pointer">
            <i class="bi bi-fire fs-4"></i>
          </div>
          <div>
            <small class="text-muted d-block fw-bold text-uppercase">Avg. Daily Burn</small>
            <span class="fw-bold fs-5">UGX {{ "{:,.0f}".format(avg_burn) }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('burnRateChart').getContext('2d');
    const rawData = {{ daily_data|tojson }};
    const labels = Object.keys(rawData).sort();
    const dataPoints = labels.map(k => rawData[k]);

    // 1. Vibrant Blue Gradient
    const gradient = ctx.createLinearGradient(0, 0, 0, 350);
    gradient.addColorStop(0, 'rgba(0, 0, 255, 0.2)'); 
    gradient.addColorStop(1, 'rgba(0, 0, 255, 0)');

    new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Cumulative Spend',
          data: dataPoints,
          borderColor: '#0000ff', 
          borderWidth: 3,
          backgroundColor: gradient,
          fill: true,
          tension: 0.4,
          pointBackgroundColor: '#ffffff',
          pointBorderColor: '#0000ff', 
          pointHoverRadius: 6
        }] // This was the missing bracket that broke the chart
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: '#1a1d1f',
            padding: 12,
            callbacks: {
              label: (context) => 'Total: UGX ' + context.parsed.y.toLocaleString()
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: { color: 'rgba(0,0,0,0.05)', drawBorder: false },
            ticks: {
              callback: v => 'UGX ' + (v/1000) + 'k',
              font: { family: 'Plus Jakarta Sans' }
            }
          },
          x: {
            grid: { display: false },
            ticks: { font: { family: 'Plus Jakarta Sans' } }
          }
        }
      }
    });
  });
</script>

</script>

<!-- Burn Rate Info Modal -->
<!-- Displays information about Burn Rate when the info icon is clicked -->
<div class="modal fade" id="burnRateInfoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg" style="border-radius: 30px; overflow: hidden">
      
      <div class="modal-header border-0 p-4 pb-0">
        <h5 class="fw-bold mb-0">Understanding Burn Rate</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body p-4">
        <div class="row align-items-center">
          <div class="col-md-5 text-center border-end">
            <div class="rounded-circle d-inline-flex p-3 mb-3" style="background: rgba(220, 53, 69, 0.1); color: #dc3545">
              <i class="bi bi-fire fs-1"></i>
            </div>
            <h4 class="fw-bold text-dark">Spending Velocity</h4>
            <p class="text-muted small">
              Your <strong>Burn Rate</strong> is the average amount of money you spend per day based on your history.
            </p>
          </div>

          <div class="col-md-7 ps-md-4">
            <div class="bg-light p-3 rounded-4 mb-3">
              <small class="text-muted d-block mb-2 text-uppercase fw-bold" style="letter-spacing: 0.5px; font-size: 0.65rem">How it's calculated</small>
              <p class="small mb-2">Total Expenses รท Days Active</p>
              <div class="p-2 bg-white rounded border text-center font-monospace small shadow-sm">
                UGX {{ "{:,.0f}".format(avg_burn) }} / Day
              </div>
            </div>

            <div class="p-3 rounded-4" style="background: #fff5f5">
              <small class="text-danger d-block mb-1 text-uppercase fw-bold" style="letter-spacing: 0.5px; font-size: 0.65rem">Pro Tip</small>
              <p class="small mb-0 text-dark">To keep your current lifestyle, ensure your daily income exceeds this burn rate.</p>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer border-0 p-4 pt-0">
        <button type="button" class="btn btn-danger w-100 py-3 rounded-4 fw-bold shadow-sm" data-bs-dismiss="modal">Got it, thanks!</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}
