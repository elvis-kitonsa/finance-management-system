{% extends "base.html" %} {% block content %}

<header class="top-nav d-flex justify-content-between align-items-center">
  <h5 class="fw-bold mb-0">FinanceFlow | Analytics</h5>
  <div class="d-flex align-items-center gap-3">
    <div class="text-end d-none d-md-block">
      <small class="text-muted d-block" id="current-day">{{ current_day }}</small>
      <span class="fw-bold small" id="current-date">{{ current_date }}</span>
    </div>
    <div class="vr mx-2"></div>

    <div class="dropdown">
      <a href="#" class="user-avatar dropdown-toggle shadow-sm text-decoration-none" id="profileDropdown" data-bs-toggle="dropdown" aria-expanded="false">
        <span id="user-initials">{{ initials }}</span>
      </a>
      <ul class="dropdown-menu dropdown-menu-end shadow border-0" aria-labelledby="profileDropdown" style="border-radius: 20px; padding: 10px">
        <li class="px-3 py-3 border-bottom">
          <p class="mb-0 small text-muted">Signed in as</p>
          <p class="mb-0 fw-bold">{{ current_user.full_name }}</p>
          <p class="mb-0 small text-muted user-email-text">{{ current_user.email }}</p>
        </li>
        <li>
          <a class="dropdown-item mt-2" href="#"><i class="bi bi-person me-2"></i> Your Profile</a>
        </li>
        <li>
          <a class="dropdown-item" href="#"><i class="bi bi-wallet2 me-2"></i> Your Accounts</a>
        </li>
        <li>
          <a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i> Settings</a>
        </li>
        <li><hr class="dropdown-divider" /></li>
        <li>
          <a class="dropdown-item text-danger" href="{{ url_for('logout') }}"><i class="bi bi-box-arrow-right me-2"></i> Sign out</a>
        </li>
      </ul>
    </div>
  </div>
</header>

<main class="p-4">
  <div class="row g-4">
    <div class="col-xl-8">
      <div class="d-flex flex-column gap-4">
      <div class="card glass-card h-100 border-0 shadow-sm">
        <div class="p-4">
          <h5 class="fw-bold">Burn Rate (Cumulative Spend)</h5>
          <br />
          <div style="height: 350px; position: relative">
            <canvas id="burnRateChart"></canvas>
          </div>
        </div>
      </div>

      <div class="card glass-card border-0 shadow-sm">
      <div class="p-4">
        <h5 class="fw-bold">Spending by Category</h5>
        <br />
        <div class="row align-items-center">
    <div class="col-md-7">
        <canvas id="categoryChart"></canvas>
    </div>
    <div class="col-md-5">
    <div id="custom-legend" class="mb-4">
        {% for category, amount in category_data.items() %}
        <div class="d-flex align-items-center mb-2">
            <span class="badge rounded-pill me-2" style="background-color: #4e73df; width: 10px; height: 10px; padding: 0;">&nbsp;</span>
            <span class="text-muted small fw-bold">{{ category }}:</span>
            <span class="ms-auto small fw-bold text-dark">UGX {{ "{:,.0f}".format(amount) }}</span>
        </div>
        {% endfor %}
    </div>

    <div class="p-3 rounded-3" style="background-color: #f8f9fc; border: 1px dashed #e3e6f0;">
        <p class="text-uppercase text-muted small fw-black mb-2">Quick Insight</p>
        
        {% set top_cat = category_data.items()|sort(attribute='1', reverse=true)|first %}
        {% if top_cat %}
        <div class="mb-2">
            <span class="small text-muted">Primary Drain:</span>
            <div class="fw-bold text-danger">{{ top_cat[0] }}</div>
        </div>
        {% endif %}

        <div class="progress" style="height: 8px;">
    <div class="progress-bar bg-success" role="progressbar" style="width: {{ spend_ratio }}%"></div>
</div>
<small class="text-muted mt-1 d-block">You've saved {{ savings_ratio|round(1) }}% of your total budget.</small>
    </div>
</div>
</div>
      </div>
    </div>
    </div>
    </div>

    <div class="col-xl-4">
      <div class="card glass-card border-0 p-4 mb-4 shadow text-white" 
        data-bs-toggle="modal" 
        data-bs-target="#runwayInfoModal"
        style="border-radius: 24px; background-color: #0000ff !important; cursor: pointer; transition: transform 0.2s;">
          <div class="d-flex justify-content-between align-items-start">
              <small class="text-white text-uppercase fw-bold" style="letter-spacing: 0.5px;">Projected Runway</small>
              <i class="bi bi-info-circle"></i>
          </div>
        <h2 class="fw-bold mb-0 text-white">{{ days_left }} Days</h2>
        <p class="mb-0 small text-white">Until capital hits UGX 0</p>
      </div>

      <div class="card glass-card border-0 p-4 shadow-sm" style="border-radius: 24px">
        <div class="d-flex align-items-center gap-3">
          <div class="icon-box bg-danger-subtle text-danger rounded-circle p-3" data-bs-toggle="modal" data-bs-target="#burnRateInfoModal" style="cursor: pointer">
            <i class="bi bi-fire fs-4"></i>
          </div>
          <div>
            <small class="text-muted d-block fw-bold text-uppercase">Avg. Daily Burn</small>
            <span class="fw-bold fs-5">UGX {{ "{:,.0f}".format(avg_burn) }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('burnRateChart').getContext('2d');
    const rawData = {{ daily_data|tojson }};
    const labels = Object.keys(rawData).sort();
    const dataPoints = labels.map(k => rawData[k]);

    // 1. Vibrant Blue Gradient
    const gradient = ctx.createLinearGradient(0, 0, 0, 350);
    gradient.addColorStop(0, 'rgba(0, 0, 255, 0.2)'); 
    gradient.addColorStop(1, 'rgba(0, 0, 255, 0)');

    new Chart(ctx, {
    type: 'line',
    data: {
        labels: labels,
        datasets: [{
            label: 'Cumulative Spend',
            data: dataPoints,
            borderColor: '#0000ff',
            borderWidth: 4, // Thicker line for better visibility
            backgroundColor: gradient,
            fill: true,
            tension: 0.45, // Smoother "Cubic" curves
            pointRadius: 6,
            pointBackgroundColor: '#ffffff',
            pointBorderColor: '#0000ff',
            pointBorderWidth: 3,
            pointHoverRadius: 8,
            pointHoverBackgroundColor: '#0000ff',
            pointHoverBorderColor: '#ffffff',
            pointHoverBorderWidth: 3
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
            intersect: false,
            mode: 'index',
        },
        plugins: {
            legend: { display: false },
            tooltip: {
                enabled: true,
                backgroundColor: 'rgba(26, 29, 31, 0.9)', // Darker, sleek tooltip
                titleFont: { size: 14, weight: 'bold', family: 'Plus Jakarta Sans' },
                bodyFont: { size: 13, family: 'Plus Jakarta Sans' },
                padding: 12,
                cornerRadius: 12,
                displayColors: false,
                callbacks: {
                    label: (context) => 'Total Spent: UGX ' + context.parsed.y.toLocaleString()
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                border: { display: true },
                grid: { color: 'rgba(0,0,0,0.03)', drawBorder: false },
                ticks: {
                    callback: v => 'UGX ' + (v >= 1000 ? (v/1000).toFixed(0) + 'k' : v),
                    font: { family: 'Plus Jakarta Sans', size: 11 },
                    padding: 10
                }
            },
            x: {
                border: { display: true },
                grid: { display: false },
                ticks: { 
                    font: { family: 'Plus Jakarta Sans', size: 11 },
                    padding: 10 
                }
            }
        }
    }
});

// 2. Category Doughnut Chart
    // 1. Get the data from Flask
const catData = {{ category_data|tojson }};

const ctxDoughnut = document.getElementById('categoryChart').getContext('2d');
new Chart(ctxDoughnut, {
    type: 'doughnut',
    data: {
        labels: Object.keys(catData), // This adds the 'Words' to the chart
        datasets: [{
            data: Object.values(catData),
            backgroundColor: [
                '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796'
            ],
            hoverBackgroundColor: ['#2e59d9', '#17a673', '#2c9faf'],
            hoverBorderColor: "rgba(234, 236, 244, 1)",
        }]
    },
    options: {
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false // We will build a custom, prettier legend in HTML
            },
            tooltip: {
                callbacks: {
                    label: function(tooltipItem) {
                        let value = tooltipItem.raw;
                        return ` ${tooltipItem.label}: UGX ${value.toLocaleString()}`;
                    }
                }
            }
        },
        cutout: '70%',
    }
  });
  });

  // Color palette matching your chart
const colors = ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'];

// Target all the little badges in your legend
document.querySelectorAll('#custom-legend .badge').forEach((badge, i) => {
    badge.style.backgroundColor = colors[i % colors.length];
});
</script>

</script>

<!-- Burn Rate Info Modal -->
<!-- Displays information about Burn Rate when the info icon is clicked -->
<div class="modal fade" id="burnRateInfoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg" style="border-radius: 30px; overflow: hidden">
      
      <div class="modal-header border-0 p-4 pb-0">
        <h5 class="fw-bold mb-0">Understanding Burn Rate</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body p-4">
        <div class="row align-items-center">
          <div class="col-md-5 text-center border-end">
            <div class="rounded-circle d-inline-flex p-3 mb-3" style="background: rgba(220, 53, 69, 0.1); color: #dc3545">
              <i class="bi bi-fire fs-1"></i>
            </div>
            <h4 class="fw-bold text-dark">Spending Velocity</h4>
            <p class="text-muted small">
              Your <strong>Burn Rate</strong> is the average amount of money you spend per day based on your history.
            </p>
          </div>

          <div class="col-md-7 ps-md-4">
            <div class="bg-light p-3 rounded-4 mb-3">
              <small class="text-muted d-block mb-2 text-uppercase fw-bold" style="letter-spacing: 0.5px; font-size: 0.65rem">How it's calculated</small>
              <p class="small mb-2">Total Expenses รท Days Active</p>
              <div class="p-2 bg-white rounded border text-center font-monospace small shadow-sm">
                UGX {{ "{:,.0f}".format(avg_burn) }} / Day
              </div>
            </div>

            <div class="p-3 rounded-4" style="background: #fff5f5">
              <small class="text-danger d-block mb-1 text-uppercase fw-bold" style="letter-spacing: 0.5px; font-size: 0.65rem">Pro Tip</small>
              <p class="small mb-0 text-dark">To keep your current lifestyle, ensure your daily income exceeds this burn rate.</p>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer border-0 p-4 pt-0">
        <button type="button" class="btn btn-danger w-100 py-3 rounded-4 fw-bold shadow-sm" data-bs-dismiss="modal">Got it, thanks!</button>
      </div>
    </div>
  </div>
</div>

<!-- Runway Info Modal -->
<!-- Explains how the Projected Runway is calculated -->
<div class="modal fade" id="runwayInfoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg" style="border-radius: 30px;">
      <div class="modal-header border-0 p-4 pb-0">
        <h5 class="fw-bold mb-0">Runway Breakdown</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="bg-light p-3 rounded-4 mb-3">
          <small class="text-muted d-block mb-1 text-uppercase fw-bold" style="font-size: 0.65rem">The Formula</small>
          <p class="mb-2">Remaining Cash รท Daily Burn Rate</p>
          <div class="d-flex justify-content-between align-items-center bg-white p-2 rounded border shadow-sm">
            <span class="small">UGX {{ "{:,.0f}".format(total_balance) }}</span>
            <span class="text-muted">รท</span>
            <span class="small">UGX {{ "{:,.0f}".format(avg_burn) }}</span>
            <span class="fw-bold text-primary">= {{ days_left }} Days</span>
          </div>
        </div>
        <p class="small text-muted">
          Based on your spending over the last few days, you are exhausting your liquid cash at a rate of <strong>UGX {{ "{:,.0f}".format(avg_burn) }}</strong> per day. At this speed, your remaining balance of <strong>UGX {{ "{:,.0f}".format(total_balance) }}</strong> will last approximately <strong>{{ days_left }}</strong> more days.
        </p>
      </div>
      <div class="modal-footer border-0 p-4 pt-0">
        <button type="button" class="btn btn-fms w-100 py-3 rounded-4 fw-bold" data-bs-dismiss="modal" style="background-color: #0000ff !important; color: white;">Understood</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}
