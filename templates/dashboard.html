<!-- Dashboard Template for FinanceFlow Application -->
<!-- Extends the base layout and populates the content block -->

{% extends "base.html" %} {% block content %}

<header class="top-nav d-flex justify-content-between align-items-center">
  <h5 class="fw-bold mb-0">FinanceFlow | Dashboard</h5>
  <div class="d-flex align-items-center gap-3">
    <div class="text-end d-none d-md-block">
      <small class="text-muted d-block" id="current-day">Loading...</small>
      <span class="fw-bold small" id="current-date">Loading...</span>
    </div>
    <div class="vr mx-2"></div>

    <div class="dropdown">
      <a href="#" class="user-avatar dropdown-toggle shadow-sm text-decoration-none" id="profileDropdown" data-bs-toggle="dropdown" aria-expanded="false">
        <span id="user-initials">{{ initials }}</span>
      </a>
      <ul class="dropdown-menu dropdown-menu-end shadow border-0" aria-labelledby="profileDropdown" style="border-radius: 20px; padding: 10px">
        <li class="px-3 py-3 border-bottom">
          <p class="mb-0 small text-muted">Signed in as</p>
          <p class="mb-0 fw-bold">{{ current_user.full_name }}</p>
          <p class="mb-0 small text-muted" style="font-size: 0.75rem">{{ current_user.email }}</p>
        </li>
        <li>
          <a class="dropdown-item mt-2" href="#"><i class="bi bi-person me-2"></i> Your Profile</a>
        </li>
        <li>
          <a class="dropdown-item" href="#"><i class="bi bi-wallet2 me-2"></i> Your Accounts</a>
        </li>
        <li>
          <a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i> Settings</a>
        </li>
        <li><hr class="dropdown-divider" /></li>
        <li>
          <a class="dropdown-item text-danger" href="{{ url_for('logout') }}"><i class="bi bi-box-arrow-right me-2"></i> Sign out</a>
        </li>
      </ul>
    </div>
  </div>
</header>

<main class="p-4">
  <div class="row row-cols-1 row-cols-md-2 row-cols-xl-4 g-4 mb-5">
    <div class="col">
      <div class="card glass-card h-100 p-4" style="overflow: visible !important; border-radius: 24px">
        <div class="d-flex justify-content-between align-items-center">
          <div style="min-width: 0">
            <p class="card-label text-muted small fw-bold mb-1">Total Balance</p>
            <h3 class="balance-text mb-0 fw-bold" id="display-total-balance">UGX {{ "{:,.0f}".format(total_balance) }}</h3>
          </div>
          <div class="icon-box shadow-sm d-flex align-items-center justify-content-center flex-shrink-0 ms-3" style="background: rgba(0, 98, 255, 0.1); color: #0000ff; width: 50px; height: 50px; border-radius: 15px; cursor: pointer" data-bs-toggle="modal" data-bs-target="#updateBalanceModal">
            <i class="bi bi-stack fs-4"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col">
      <div class="card glass-card h-100">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <p class="card-label">Total Amount Spent</p>
            <h3 class="balance-text text-danger mb-0">UGX {{ "{:,.0f}".format(total_spent) }}</h3>
          </div>
          <div class="icon-box shadow-sm" style="background: rgba(239, 68, 68, 0.1); color: #ef4444">
            <i class="bi bi-receipt-cutoff"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col">
      <div class="card glass-card h-100">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <p class="card-label">Total Amount Remaining</p>
            <h3 class="balance-text text-success mb-0">UGX {{ "{:,.0f}".format(total_remaining) }}</h3>
          </div>
          <div class="icon-box shadow-sm" style="background: rgba(34, 197, 94, 0.1); color: #22c55e">
            <i class="bi bi-cash-stack"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col">
      <div class="card glass-card h-100">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <p class="card-label">Amount Saved</p>
            <h3 class="balance-text mb-0" style="color: #0000ff">UGX {{ "{:,.0f}".format(amount_saved) }}</h3>
          </div>
          <div class="icon-box shadow-sm" style="background: rgba(0, 0, 255, 0.1); color: #0000ff">
            <i class="bi bi-graph-up-arrow"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h5 class="fw-bold mb-0">List | Registered Expenses</h5>

    <button class="btn btn-fms px-4 py-2 rounded-4 fw-bold shadow-sm" data-bs-toggle="modal" data-bs-target="#expenseModal"><i class="bi bi-plus-lg me-2"></i>Record Expense</button>
  </div>

  <div class="card glass-card overflow-hidden">
    <table class="table mb-0 table-hover align-middle">
      <thead class="bg-light">
        <tr>
          <th class="ps-4 border-0 py-3 text-muted small">DESCRIPTION</th>
          <th class="border-0 py-3 text-muted small">CATEGORY</th>
          <th class="border-0 py-3 text-muted small text-center">STATUS</th>
          <th class="pe-4 border-0 py-3 text-muted small text-end">AMOUNT</th>
        </tr>
      </thead>
      <tbody>
        {% for expense in expenses %}
        <tr
          class="align-middle border-bottom"
          style="cursor: pointer"
          data-id="{{ expense.id }}"
          data-title="{{ expense.title }}"
          data-category="{{ expense.category }}"
          data-amount="{{ expense.amount }}"
          data-date="{{ expense.date_to_handle.strftime('%d %b, %Y | %I:%M %p') }}"
          onclick="handleRowClick(this)"
        >
          <td class="ps-4 py-3">
            <div class="d-flex flex-column">
              <span class="fw-bold text-dark">{{ expense.title }}</span>
              <small class="text-muted" style="font-size: 0.7rem"><i class="bi bi-calendar3 me-1"></i>{{ expense.date_to_handle.strftime('%d %b, %I:%M %p') }}</small>
            </div>
          </td>
          <td>
            <span
              class="badge rounded-pill px-3 py-2 {% if expense.category in ['Savings', 'Investment'] %}bg-primary shadow-sm {% elif expense.category == 'Food' %}bg-warning text-dark {% elif expense.category == 'Transport' %}bg-info text-dark {% elif expense.category == 'Bills' %}bg-danger {% elif expense.category == 'Health' %}bg-success {% else %}bg-secondary{% endif %}"
            >
              {{ expense.category }}
            </span>
          </td>
          <td class="text-center">
            {% if expense.is_covered %}
            <span class="badge bg-success-subtle text-success border border-success-subtle px-3 py-2"> <i class="bi bi-shield-check me-1"></i> Covered </span>
            {% else %}
            <span class="badge bg-warning-subtle text-warning border border-warning-subtle px-3 py-2"> <i class="bi bi-clock-history me-1"></i> Pending </span>
            {% endif %}
          </td>
          <td class="pe-4 text-end fw-bold {% if expense.category == 'Savings' %}text-primary{% else %}text-danger{% endif %}">{% if expense.category != 'Savings' %}-{% endif %}{{ "{:,.0f}".format(expense.amount) }}</td>
        </tr>
        {% else %}
        <tr>
          <td colspan="4" class="text-center py-5 text-muted"><i class="bi bi-inbox fs-2 d-block mb-2"></i>No transactions recorded yet.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="mt-3">
    <button
      class="btn btn-outline-danger w-100 py-2 fw-bold"
      onclick="
        document.getElementById('reset-all-data').checked = true;
        toggleResetConfirm(true);
      "
      data-bs-toggle="modal"
      data-bs-target="#updateBalanceModal"
    >
      <i class="bi bi-trash3-fill me-2"></i> Clear All Expenses & Reset Dashboard
    </button>
  </div>
</main>

<div class="modal fade" id="updateBalanceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content glass-card border-0">
      <div class="modal-header border-0 pb-0">
        <h5 class="fw-bold">Adjust Budget</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Balance Setup View -->
      <!-- This view allows users to adjust their total balance -->
      <div class="modal-body py-4">
        <div id="balance-setup-view">
          <div class="text-center mb-4">
            <small class="text-muted text-uppercase fw-bold">Current Adjustment</small>
            <div class="d-flex align-items-center justify-content-center gap-3 mt-2">
              <button class="btn btn-outline-fms rounded-circle p-2" onclick="adjustValue(-25000)">
                <i class="bi bi-dash-lg"></i>
              </button>
              <input type="number" id="balance-input" class="form-control form-control-lg text-center fw-bold border-0 bg-light text-fms-blue" value="{{ total_balance }}" style="width: 200px; border-radius: 15px" />
              <button class="btn btn-outline-fms rounded-circle p-2" onclick="adjustValue(25000)">
                <i class="bi bi-plus-lg"></i>
              </button>
            </div>
            <p class="small text-muted mt-3">Step size: 25,000 UGX</p>
          </div>
          <div class="form-check form-switch d-flex justify-content-center gap-3 mb-4">
            <input class="form-check-input" type="checkbox" id="reset-all-data" />
            <label class="form-check-label fw-bold text-danger" for="reset-all-data">Reset all expenses & cards?</label>
          </div>
          <button class="btn btn-fms w-100 py-3 rounded-4 fw-bold shadow-sm" onclick="checkResetFlag()">Update Balance</button>
        </div>
        <div id="reset-confirm-view" class="d-none text-center py-4">
          <div class="bg-danger-subtle text-danger rounded-circle d-inline-flex p-3 mb-3">
            <i class="bi bi-exclamation-triangle-fill fs-2"></i>
          </div>
          <h4 class="fw-bold">Clear All Data?</h4>
          <div class="d-flex gap-2 mt-4">
            <button class="btn btn-light rounded-pill fw-bold flex-grow-1" onclick="toggleResetConfirm(false)">No, Go Back</button>
            <button class="btn btn-danger rounded-pill fw-bold flex-grow-1" onclick="saveNewBalance()">Yes, Clear All</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="expenseModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content glass-card border-0">
      <div class="modal-header border-0 pb-0">
        <h5 class="fw-bold">Record New Entry</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body py-4">
        <form id="expense-form">
          <div class="mb-3">
            <label class="form-label small fw-bold text-muted">DESCRIPTION</label>
            <input type="text" id="expense-desc" class="form-control border-0 bg-light rounded-3" placeholder="Describe your expense" required />
          </div>
          <div class="mb-3">
            <label class="form-label small fw-bold text-muted">CATEGORY</label>
            <select class="form-select border-0 bg-light rounded-3 shadow-sm" id="expense-category">
              <optgroup label="Essential & Home">
                <option value="Food">üçΩÔ∏è Food & Dining</option>
                <option value="Transport">‚õΩ Transport & Fuel</option>
                <option value="Bills">üîå Utilities & Bills</option>
                <option value="Rent">üè† Rent & Mortgage</option>
                <option value="Health">üíä Health & Medical</option>
              </optgroup>

              <optgroup label="Lifestyle & Personal">
                <option value="Shopping">üõçÔ∏è Shopping</option>
                <option value="Entertainment">üéüÔ∏è Entertainment</option>
                <option value="Education">üéì Learning & Skills</option>
                <option value="PersonalCare">üíà Personal Care</option>
              </optgroup>

              <optgroup label="Financial & Future">
                <option value="Savings">üè¶ Savings</option>
                <option value="Investment">üìä Investment</option>
                <option value="Debt">üí≥ Debt & Loans</option>
                <option value="Emergency">üö® Emergency Fund</option>
              </optgroup>
            </select>
          </div>
          <div class="mb-4">
            <label class="form-label small fw-bold text-muted">AMOUNT (UGX)</label>
            <input type="number" id="expense-amount" class="form-control form-control-lg border-0 bg-light rounded-3 fw-bold text-primary" placeholder="0" required />
          </div>
          <button type="submit" id="save-btn" class="btn btn-fms w-100 py-3 rounded-4 fw-bold shadow-sm">Save Entry</button>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="expenseDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content expense-modal-card">
      <div class="modal-header border-0 pb-0">
        <h5 class="fw-bold text-dark mb-0">Transaction Receipt</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="receipt-view">
          <div class="text-center mb-4">
            <div class="status-badge-container"><i class="bi bi-check-circle-fill text-success fs-1"></i></div>
            <div class="fw-bold fs-4" id="modalAmount">UGX 0</div>
            <div class="text-muted small text-uppercase">Transaction Verified</div>
          </div>
          <div class="detail-list">
            <div class="detail-item">
              <span class="label"><i class="bi bi-pencil-square me-2 text-primary" id="enable-edit-desc" style="cursor: pointer"></i> Description</span>
              <span class="value fw-medium" id="modalDescription">-</span>
            </div>
            <div class="detail-item">
              <span class="label"><i class="bi bi-tag me-2"></i>Category</span>
              <span class="value" id="modalCategory">-</span>
            </div>
            <div class="detail-item">
              <span class="label"><i class="bi bi-calendar3 me-2"></i>Date & Time</span>
              <span class="value" id="modalDateTime">-</span>
            </div>
          </div>
        </div>
        <div id="confirm-view" class="d-none text-center py-4">
          <div class="bg-danger-subtle text-danger rounded-circle d-inline-flex p-3 mb-3">
            <i class="bi bi-exclamation-triangle-fill fs-2"></i>
          </div>
          <h5 class="fw-bold">Delete Expense?</h5>
        </div>
      </div>
      <div class="modal-footer border-0 d-flex gap-2">
        <input type="hidden" id="modalExpenseId" value="" />
        <div id="receipt-footer-btns" class="w-100 d-flex gap-2">
          <button type="button" id="markPaidBtn" class="btn btn-success rounded-pill fw-bold flex-grow-1" onclick="markAsPaid()"><i class="bi bi-check-lg me-2"></i>Mark as Paid</button>
          <button type="button" class="btn btn-outline-danger rounded-pill fw-bold" onclick="toggleDeleteConfirm(true)"><i class="bi bi-trash3"></i></button>
        </div>
        <div id="confirm-footer-btns" class="w-100 d-flex gap-2 d-none">
          <button type="button" class="btn btn-danger rounded-pill fw-bold flex-grow-1" onclick="executeDelete()">Yes, Delete</button>
          <button type="button" class="btn btn-light rounded-pill fw-bold flex-grow-1" onclick="toggleDeleteConfirm(false)">Cancel</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="{{ url_for('static', filename='js/main.js') }}"></script>

{% endblock %}
