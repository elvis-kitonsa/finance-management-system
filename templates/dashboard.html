<!-- Dashboard Template for FinanceFlow Application -->
<!-- Extends the base layout and populates the content block -->

{% extends "base.html" %} {% block content %}

<header class="top-nav d-flex justify-content-between align-items-center">
  <h5 class="fw-bold mb-0">FinanceFlow | Dashboard</h5>
  <div class="d-flex align-items-center gap-3">
    <div class="text-end d-none d-md-block">
      <small class="text-muted d-block" id="current-day">Loading...</small>
      <span class="fw-bold small" id="current-date">Loading...</span>
    </div>
    <div class="vr mx-2"></div>

    <div class="dropdown">
      <a href="#" class="user-avatar dropdown-toggle shadow-sm text-decoration-none" id="profileDropdown" data-bs-toggle="dropdown" aria-expanded="false">
        <span id="user-initials">{{ initials }}</span>
      </a>
      <ul class="dropdown-menu dropdown-menu-end shadow border-0" aria-labelledby="profileDropdown" style="border-radius: 20px; padding: 10px">
        <li class="px-3 py-3 border-bottom">
          <p class="mb-0 small text-muted">Signed in as</p>
          <p class="mb-0 fw-bold">{{ current_user.full_name }}</p>
          <p class="mb-0 small text-muted user-email-text">{{ current_user.email }}</p>
        </li>
        <li>
          <a class="dropdown-item mt-2" href="{{ url_for('profile') }}"><i class="bi bi-person me-2"></i> Your Profile</a>
        </li>
        <li>
          <a class="dropdown-item" href="#"><i class="bi bi-wallet2 me-2"></i> Your Accounts</a>
        </li>
        <li>
          <a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i> Settings</a>
        </li>
        <li><hr class="dropdown-divider" /></li>
        <li>
          <a class="dropdown-item text-danger" href="{{ url_for('logout') }}"><i class="bi bi-box-arrow-right me-2"></i> Sign out</a>
        </li>
      </ul>
    </div>
  </div>
</header>

<main class="p-4">
  <!-- Summary Cards Section -->
  <!-- Displays key financial metrics in a responsive grid layout -->
  <div class="row row-cols-1 row-cols-md-2 row-cols-xl-4 g-4 mb-5">
    <div class="col">
      <!-- Total Amount Card in the Dashboard -->
      <div class="card glass-card h-100 p-4" style="overflow: visible !important; border-radius: 24px">
        <div class="d-flex justify-content-between align-items-center">
          <div style="min-width: 0">
            <p class="card-label text-muted small fw-bold mb-1">Total Amount Set</p>
            <h3 class="balance-text mb-0 fw-bold" id="display-total-balance">UGX {{ "{:,.0f}".format(total_balance) }}</h3>
          </div>
          <div class="icon-box shadow-sm d-flex align-items-center justify-content-center flex-shrink-0 ms-3" style="background: rgba(0, 98, 255, 0.1); color: #0000ff; width: 50px; height: 50px; border-radius: 15px; cursor: pointer" data-bs-toggle="modal" data-bs-target="#updateBalanceModal">
            <i class="bi bi-stack fs-4"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col">
      <div class="card glass-card h-100">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <p class="card-label">Total Amount Spent</p>
            <h3 class="balance-text text-danger mb-0">UGX {{ "{:,.0f}".format(total_spent) }}</h3>
          </div>
          <div class="icon-box shadow-sm" style="background: rgba(239, 68, 68, 0.1); color: #ef4444; cursor: pointer" data-bs-toggle="modal" data-bs-target="#spentInsightModal">
            <i class="bi bi-receipt-cutoff"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Amount Saved Card in the Dashboard -->
    <div class="col">
      <div class="card glass-card h-100">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <p class="card-label">Total Amount Remaining</p>
            <h3 class="balance-text text-success mb-0" id="current-remaining-val">UGX {{ "{:,.0f}".format(total_remaining) }}</h3>
          </div>
          <div class="icon-box shadow-sm" style="background: rgba(34, 197, 94, 0.1); color: #22c55e; cursor: pointer" data-bs-toggle="modal" data-bs-target="#remainingInsightModal">
            <i class="bi bi-cash-stack"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Amount Saved Card in the Dashboard -->
    <div class="col">
      <div class="card glass-card h-100">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <p class="card-label">Amount Saved</p>
            <h3 class="balance-text text-primary mb-0">UGX {{ "{:,.0f}".format(total_saved) }}</h3>
          </div>
          <div class="icon-box shadow-sm" style="background: rgba(37, 99, 235, 0.1); color: #2563eb; cursor: pointer" data-bs-toggle="modal" data-bs-target="#savingsInsightModal">
            <i class="bi bi-graph-up-arrow"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h5 class="fw-bold mb-0">List | Registered Expenses</h5>

    <button class="btn btn-fms px-4 py-2 rounded-4 fw-bold shadow-sm" data-bs-toggle="modal" data-bs-target="#expenseModal"><i class="bi bi-plus-lg me-2"></i>Record Expense</button>
  </div>

  <div class="card glass-card overflow-hidden">
    <table class="table mb-0 table-hover align-middle">
      <thead class="bg-light">
        <tr>
          <th class="ps-4 border-0 py-3 text-muted small">DESCRIPTION</th>
          <th class="border-0 py-3 text-muted small">CATEGORY</th>
          <th class="border-0 py-3 text-muted small text-center">STATUS</th>
          <th class="pe-4 border-0 py-3 text-muted small text-end">AMOUNT</th>
        </tr>
      </thead>
      <tbody>
        {% for expense in expenses %}
        <tr
          class="align-middle border-bottom"
          style="cursor: pointer"
          data-id="{{ expense.id }}"
          data-title="{{ expense.title }}"
          data-category="{{ expense.category }}"
          data-amount="{{ expense.amount }}"
          data-date="{{ expense.date_to_handle.strftime('%d %b, %Y | %I:%M %p') }}"
          data-covered="{{ 'True' if expense.is_covered else 'False' }}"
          onclick="handleRowClick(this)"
        >
          <td class="ps-4 py-3">
            <div class="d-flex flex-column">
              <span class="fw-bold text-dark">{{ expense.title }}</span>
              <small class="text-muted" style="font-size: 0.7rem"><i class="bi bi-calendar3 me-1"></i>{{ expense.date_to_handle.strftime('%d %b, %I:%M %p') }}</small>
            </div>
          </td>
          <td>
            <span
              class="badge rounded-pill px-3 py-2 {% if expense.category in ['Savings', 'Investment'] %}bg-primary shadow-sm {% elif expense.category == 'Food' %}bg-warning text-dark {% elif expense.category == 'Transport' %}bg-info text-dark {% elif expense.category == 'Bills' %}bg-danger {% elif expense.category == 'Health' %}bg-success {% else %}bg-secondary{% endif %}"
            >
              {{ expense.category }}
            </span>
          </td>
          <td class="text-center">
            {% if expense.is_covered %}
            <span class="badge bg-success-subtle text-success border border-success-subtle px-3 py-2"> <i class="bi bi-shield-check me-1"></i> Covered </span>
            {% else %}
            <span class="badge bg-warning-subtle text-warning border border-warning-subtle px-3 py-2"> <i class="bi bi-clock-history me-1"></i> Pending </span>
            {% endif %}
          </td>
          <td class="pe-4 text-end fw-bold {% if expense.category == 'Savings' %}text-primary{% else %}text-danger{% endif %}">{% if expense.category != 'Savings' %}-{% endif %}{{ "{:,.0f}".format(expense.amount) }}</td>
        </tr>
        {% else %}
        <tr>
          <td colspan="4" class="text-center py-5 text-muted"><i class="bi bi-inbox fs-2 d-block mb-2"></i>No transactions recorded yet.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="mt-3">
    <button
      class="btn btn-outline-danger w-100 py-2 fw-bold"
      onclick="
        document.getElementById('reset-all-data').checked = true;
        toggleResetConfirm(true);
      "
      data-bs-toggle="modal"
      data-bs-target="#updateBalanceModal"
    >
      <i class="bi bi-trash3-fill me-2"></i> Clear All Expenses & Reset Dashboard
    </button>
  </div>
</main>

<!-- Update Balance Modal -->
<div class="modal fade" id="updateBalanceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content glass-card border-0">
      <div class="modal-header border-0 pb-0">
        <h5 class="fw-bold">Adjust Budget</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Balance Setup View -->
      <!-- This view allows users to adjust their total balance -->
      <div class="modal-body py-4">
        <div id="balance-setup-view">
          <div class="text-center mb-4">
            <label class="small fw-bold text-muted d-block mb-3 text-uppercase" style="letter-spacing: 1.5px; font-size: 0.7rem">Current Balance</label>

            <small class="text-muted text-uppercase fw-bold"></small>
            <div class="d-flex align-items-center justify-content-center gap-3 mt-2">
              <button class="btn btn-outline-fms rounded-circle p-2" onclick="adjustValue(-25000)">
                <i class="bi bi-dash-lg"></i>
              </button>
              <input type="number" id="balance-input" class="form-control form-control-lg text-center fw-bold border-0 bg-light text-fms-blue" value="{{ total_balance }}" style="width: 200px; border-radius: 15px" />
              <button class="btn btn-outline-fms rounded-circle p-2" onclick="adjustValue(25000)">
                <i class="bi bi-plus-lg"></i>
              </button>
            </div>
            <p class="small text-muted mt-3">Step size: 25,000 UGX</p>
          </div>
          <div class="form-check form-switch d-flex justify-content-center gap-3 mb-4">
            <input class="form-check-input" type="checkbox" id="reset-all-data" />
            <label class="form-check-label fw-bold text-danger" for="reset-all-data">Reset all expenses & cards?</label>
          </div>
          <button class="btn btn-fms w-100 py-3 rounded-4 fw-bold shadow-sm" onclick="checkResetFlag()">Update Balance</button>
        </div>
        <div id="reset-confirm-view" class="d-none text-center py-4">
          <div class="bg-danger-subtle text-danger rounded-circle d-inline-flex p-3 mb-3">
            <i class="bi bi-exclamation-triangle-fill fs-2"></i>
          </div>
          <h4 class="fw-bold">Clear All Data?</h4>
          <div class="d-flex gap-2 mt-4">
            <button class="btn btn-light rounded-pill fw-bold flex-grow-1" onclick="toggleResetConfirm(false)">No, Go Back</button>
            <button class="btn btn-danger rounded-pill fw-bold flex-grow-1" onclick="saveNewBalance()">Yes, Clear All</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- New Expense Modal: User can add a new expense -->
<div class="modal fade" id="expenseModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg" style="border-radius: 35px; background: #ffffff">
      <div class="modal-header border-0 p-4 pb-0">
        <h5 class="fw-bold mb-0" style="color: #000000; font-style: normal">New Expenditure Task</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body p-4">
        <form id="expense-form">
          <!-- Description Input Field -->
          <!-- This field captures what the expense is for -->
          <div class="mb-4">
            <label class="small fw-bold text-muted text-uppercase mb-2" style="letter-spacing: 1px; font-style: normal">What is this for?</label>
            <div class="input-group overflow-hidden shadow-sm position-relative" style="border-radius: 18px">
              <span class="input-group-text border-0 bg-light px-3">
                <i class="bi bi-chat-left-text text-primary fs-5"></i>
              </span>

              <input type="text" id="expense-description" class="form-control border-0 bg-light py-3 fw-bold pe-5" placeholder="Describe your expense" style="font-style: normal" />

              <button type="button" id="clear-desc-btn" class="btn position-absolute top-50 end-0 translate-middle-y border-0 text-muted d-none" style="z-index: 5; margin-right: 10px">
                <i class="bi bi-x-circle-fill"></i>
              </button>
            </div>
          </div>

          <div class="mb-4">
            <label class="small fw-bold text-muted text-uppercase mb-2" style="letter-spacing: 1px; font-style: normal">Select Expense Category</label>
            <div class="position-relative">
              <span class="position-absolute top-50 translate-middle-y ms-3" style="z-index: 5"><i class="bi bi-folder2-open text-primary"></i></span>
              <select class="form-select border-0 bg-light py-3 fw-bold shadow-sm ps-5" id="expense-category" style="border-radius: 18px; font-style: normal; cursor: pointer">
                <optgroup label="Essential & Home" style="font-style: normal; font-weight: bold">
                  <option value="Food">üçΩÔ∏è Food & Dining</option>
                  <option value="Transport">‚õΩ Transport & Fuel</option>
                  <option value="Bills">üîå Utilities & Bills</option>
                  <option value="Rent">üè† Rent & Mortgage</option>
                  <option value="Health">üíä Health & Medical</option>
                  <option value="Insurance">üõ°Ô∏è Insurance</option>
                </optgroup>

                <optgroup label="Lifestyle & Personal" style="font-style: normal; font-weight: bold">
                  <option value="Shopping">üõçÔ∏è Shopping & Clothes</option>
                  <option value="Entertainment">üéüÔ∏è Entertainment & Fun</option>
                  <option value="Education">üéì Learning & Skills</option>
                  <option value="PersonalCare">üíà Personal Care</option>
                  <option value="Gifts">üéÅ Gifts & Donations</option>
                </optgroup>

                <optgroup label="Financial & Future" style="font-style: normal; font-weight: bold">
                  <option value="Savings">üè¶ Savings Deposit</option>
                  <option value="Investment">üìä Investment Fund</option>
                  <option value="Debt">üí≥ Debt & Loans</option>
                  <option value="Emergency">üö® Emergency Fund</option>
                  <option value="Crypto">ü™ô Crypto & Digital Assets</option>
                </optgroup>
              </select>
            </div>
          </div>

          <div class="mb-4">
            <label class="small fw-bold text-muted text-uppercase mb-2" style="letter-spacing: 1px; font-style: normal">Amount to Cover Expense (UGX)</label>
            <div class="input-group overflow-hidden shadow-sm" style="border-radius: 18px">
              <span class="input-group-text border-0 bg-light fw-bold text-primary px-3">UGX</span>
              <input type="number" id="expense-amount" class="form-control border-0 bg-light py-3 fw-bold fs-5" placeholder="0" required style="font-style: normal" />
            </div>
          </div>

          <button type="submit" id="save-btn" class="btn btn-primary w-100 py-3 fw-bold rounded-4 shadow-sm" style="background: #0000ff !important; border-radius: 20px !important">Add Expense</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Expense Detail Modal: View and manage individual expense details -->
<!-- This modal shows detailed information about a selected expense and allows marking it as paid or deleting it -->
<div class="modal fade" id="expenseDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg" style="border-radius: 30px; overflow: hidden">
      <div class="modal-header border-0 p-4 pb-2">
        <h5 class="fw-bold text-dark mb-0" style="letter-spacing: -0.5px">Transaction Receipt</h5>
        <button type="button" class="btn-close ms-auto" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body p-4 pt-0">
        <div id="receipt-view">
          <div class="text-center mb-5 mt-3">
            <div class="status-badge-container mb-3">
              <i class="bi bi-check-circle-fill text-primary" style="font-size: 3.5rem; filter: drop-shadow(0 4px 8px rgba(0, 0, 255, 0.2))"></i>
            </div>
            <h2 class="fw-bold text-dark mb-1" id="modalAmount">UGX 0</h2>
            <div class="text-muted small fw-bold text-uppercase" style="letter-spacing: 1px">Transaction Verified</div>
          </div>

          <div class="detail-list bg-light p-4" style="border-radius: 20px">
            <div class="detail-item d-flex justify-content-between mb-3 border-bottom pb-2">
              <span class="text-muted small fw-bold text-uppercase"><i class="bi bi-pencil-square me-2"></i>Description</span>
              <span class="fw-bold text-dark" id="modalDescription">-</span>
            </div>
            <div class="detail-item d-flex justify-content-between mb-3 border-bottom pb-2">
              <span class="text-muted small fw-bold text-uppercase"><i class="bi bi-tag me-2"></i>Category</span>
              <span class="badge bg-white text-primary border shadow-sm px-3" id="modalCategory">-</span>
            </div>
            <div class="detail-item d-flex justify-content-between">
              <span class="text-muted small fw-bold text-uppercase"><i class="bi bi-calendar3 me-2"></i>Date & Time</span>
              <span class="fw-medium text-dark" id="modalDateTime">-</span>
            </div>
          </div>
        </div>

        <div id="confirm-view" class="d-none text-center py-4">
          <div class="bg-danger-subtle text-danger rounded-circle d-inline-flex p-4 mb-3">
            <i class="bi bi-exclamation-triangle-fill fs-1"></i>
          </div>
          <h4 class="fw-bold text-dark">Delete Expense?</h4>
          <p class="text-muted">This action cannot be undone.</p>
        </div>
      </div>

      <div class="modal-footer border-0 p-4 pt-0">
        <input type="hidden" id="modalExpenseId" value="" />
        <div id="receipt-footer-btns" class="w-100 d-flex gap-3 align-items-center">
          <button type="button" id="markPaidBtn" class="btn btn-primary rounded-4 py-3 fw-bold flex-grow-1 shadow-sm" onclick="markAsPaid()" style="background: #0000ff !important"><i class="bi bi-check-lg me-2"></i>Mark as Paid</button>

          <button type="button" class="btn btn-outline-danger rounded-4 py-3 px-4" onclick="toggleDeleteConfirm(true)">
            <i class="bi bi-trash3"></i>
          </button>
        </div>

        <div id="confirm-footer-btns" class="w-100 d-flex gap-2 d-none">
          <button type="button" class="btn btn-danger rounded-4 py-3 fw-bold flex-grow-1" onclick="executeDelete()">Yes, Delete</button>
          <button type="button" class="btn btn-light rounded-4 py-3 fw-bold flex-grow-1" onclick="toggleDeleteConfirm(false)">Cancel</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Spent Insight Modal: Provides analytics on user's spending -->
<!-- This modal gives users an overview of their expenditure and financial health tips -->
<div class="modal fade" id="spentInsightModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg" style="border-radius: 30px; overflow: hidden">
      <div class="modal-header border-0 p-4 pb-0">
        <h5 class="fw-bold mb-0">Spending Analytics</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4 text-center">
        <div class="rounded-circle d-inline-flex p-4 mb-3" style="background: rgba(239, 68, 68, 0.1); color: #ef4444">
          <i class="bi bi-pie-chart-fill fs-1"></i>
        </div>

        <h4 class="fw-bold text-dark">Expenditure Overview</h4>
        <p class="text-muted px-2">
          You've utilized <strong>UGX {{ "{:,.0f}".format(total_spent) }}</strong> of your total capital. This is approximately <strong>{{ "{:.1f}".format((total_spent / total_balance * 100) if total_balance > 0 else 0) }}%</strong>
          of your total funds.
        </p>

        <div class="progress mb-4" style="height: 10px; border-radius: 10px; background-color: #f0f0f0">
          <div class="progress-bar bg-danger" role="progressbar" style="width: {{ (total_spent / total_balance * 100) if total_balance > 0 else 0 }}%; border-radius: 10px;"></div>
        </div>

        <div class="bg-light p-3 rounded-4">
          <small class="text-muted d-block mb-1 text-uppercase fw-bold" style="letter-spacing: 0.5px; font-size: 0.65rem">Financial Health Tip</small>
          <p class="small mb-0">If this exceeds 70%, consider reviewing your "Essential & Home" categories for potential savings.</p>
        </div>
      </div>
      <div class="modal-footer border-0 p-4 pt-0">
        <button type="button" class="btn btn-dark w-100 py-3 rounded-4 fw-bold shadow-sm" data-bs-dismiss="modal">Got it!</button>
      </div>
    </div>
  </div>
</div>

<!-- Remaining Insight Modal: Provides insights on remaining budget -->
<!-- This modal helps users understand their remaining funds and encourages prudent financial management -->
<div class="modal fade" id="remainingInsightModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg" style="border-radius: 30px; overflow: hidden">
      <div class="modal-header border-0 p-4 pb-0">
        <h5 class="fw-bold mb-0">Budget Balance Analytics</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4 text-center">
        <div class="rounded-circle d-inline-flex p-4 mb-3" style="background: rgba(34, 197, 94, 0.1); color: #22c55e !important; min-width: 80px; min-height: 80px; align-items: center; justify-content: center">
          <i class="bi bi-shield-check fs-1"></i>
        </div>

        <h4 class="fw-bold text-dark">Available Funds</h4>
        <p class="text-muted px-2">
          You currently have <strong>{{ "{:.1f}".format((total_remaining / total_balance * 100) if total_balance > 0 else 0) }}%</strong>
          of your total added budget left to allocate.
        </p>

        <div class="progress mb-4" style="height: 12px; border-radius: 10px; background-color: #f1f3f5">
          <div class="progress-bar bg-success" role="progressbar" style="width: {{ (total_remaining / total_balance * 100) if total_balance > 0 else 0 }}%; border-radius: 10px;"></div>
        </div>

        <div class="p-3 rounded-4" style="background: #f8f9fa">
          <small class="text-muted d-block mb-1 text-uppercase fw-bold" style="letter-spacing: 0.5px; font-size: 0.65rem">Quick Observation</small>
          <p class="small mb-0 text-dark text-center">Maintaining a healthy remaining balance allows you to cover unexpected expenses without stress.</p>
        </div>
      </div>
      <div class="modal-footer border-0 p-4 pt-0">
        <button type="button" class="btn btn-dark w-100 py-3 rounded-4 fw-bold shadow-sm" data-bs-dismiss="modal">Got it!</button>
      </div>
    </div>
  </div>
</div>

<!-- Savings Insight Modal: Provides insights on savings progress -->
<!-- This modal encourages users to continue saving and highlights their savings achievements -->
<div class="modal fade" id="savingsInsightModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg" style="border-radius: 30px; overflow: hidden">
      <div class="modal-header border-0 p-4 pb-0">
        <h5 class="fw-bold mb-0">Savings Milestone</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4 text-center">
        <div class="rounded-circle d-inline-flex p-4 mb-3" style="background: rgba(37, 99, 235, 0.1); color: #2563eb">
          <i class="bi bi-trophy-fill fs-1"></i>
        </div>

        <h4 class="fw-bold text-dark">Wealth Building</h4>
        <p class="text-muted px-2">
          You have successfully set aside <strong>UGX {{ "{:,.0f}".format(total_saved) }}</strong>. This is <strong>{{ "{:.1f}".format((total_saved / total_balance * 100) if total_balance > 0 else 0) }}%</strong>
          of your total financial flow.
        </p>

        <div class="progress mb-4" style="height: 12px; border-radius: 10px; background-color: #f1f3f5">
          <div class="progress-bar bg-primary" role="progressbar" style="width: {{ (total_saved / total_balance * 100) if total_balance > 0 else 0 }}%; border-radius: 10px;"></div>
        </div>

        <div class="p-3 rounded-4" style="background: #eef2ff">
          <small class="text-primary d-block mb-1 text-uppercase fw-bold" style="letter-spacing: 0.5px; font-size: 0.65rem">Savings Insight</small>
          <p class="small mb-0 text-dark">Every shilling saved is a step toward your long-term goals. Keep this momentum going to reach your next big milestone!</p>
        </div>
      </div>
      <div class="modal-footer border-0 p-4 pt-0">
        <button type="button" class="btn btn-primary w-100 py-3 rounded-4 fw-bold shadow-sm" data-bs-dismiss="modal">Keep Saving!</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast Notification for Budget Exceeding Alert -->
<!-- This toast appears when a user tries to add an expense that exceeds their remaining balance -->
<div id="budgetToast" class="position-fixed bottom-0 end-0 p-3" style="z-index: 2000">
  <div class="toast align-items-center text-white bg-danger border-0 shadow-lg" role="alert" aria-live="assertive" aria-atomic="true" style="border-radius: 15px">
    <div class="d-flex p-3">
      <div class="toast-body d-flex align-items-center">
        <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
        <div>
          <strong class="d-block">Transaction Blocked</strong>
          <span id="toastErrorMessage">This amount exceeds your remaining balance.</span>
        </div>
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>
<script src="{{ url_for('static', filename='js/main.js') }}"></script>

<!-- Script to handle the clear button for the description input -->
<script>
  // Selecting the elements
  const descInput = document.getElementById("expense-description");
  const clearBtn = document.getElementById("clear-desc-btn");

  // Logic: Show the 'X' only if there is text
  descInput.addEventListener("input", function () {
    clearBtn.style.display = this.value.length > 0 ? "block" : "none";
  });

  // Logic: Clear the text when the 'X' is clicked
  clearBtn.addEventListener("click", function () {
    descInput.value = "";
    this.style.display = "none";
    descInput.focus();
  });

  // Function to mark an expense as paid
  // What this means is that the expense's status is updated in the backend
  function markAsPaid() {
    const expenseId = document.getElementById("modalExpenseId").value;

    fetch(`/mark_paid/${expenseId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.status === "success") {
          // Refresh the page to show the "Covered" status and updated remaining balance
          location.reload();
        } else {
          // Optional: Use our new showBudgetError instead of alert
          alert("Error updating expense: " + data.message);
        }
      })
      .catch((error) => console.error("Error:", error));
  }
</script>
{% endblock %}
