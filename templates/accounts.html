{% extends "base.html" %} {% block content %}

<header class="top-nav d-flex justify-content-between align-items-center">
  <h5 class="fw-bold mb-0">FinanceFlow | Accounts</h5>
  <div class="d-flex align-items-center gap-3">
    <div class="text-end d-none d-md-block">
      <small class="text-muted d-block" id="current-day">Loading...</small>
      <span class="fw-bold small" id="current-date">Loading...</span>
    </div>
    <div class="vr mx-2"></div>

    <div class="dropdown">
      <a href="#" class="user-avatar dropdown-toggle shadow-sm text-decoration-none" id="profileDropdown" data-bs-toggle="dropdown" aria-expanded="false">
        <span id="user-initials">{{ initials }}</span>
      </a>
      <ul class="dropdown-menu dropdown-menu-end shadow border-0" aria-labelledby="profileDropdown" style="border-radius: 20px; padding: 10px">
        <li class="px-3 py-3 border-bottom">
          <p class="mb-0 small text-muted">Signed in as</p>
          <p class="mb-0 fw-bold">{{ current_user.full_name }}</p>
          <p class="mb-0 small text-muted user-email-text">{{ current_user.email }}</p>
        </li>
        <li>
          <a class="dropdown-item mt-2" href="{{ url_for('profile') }}"><i class="bi bi-person me-2"></i> Your Profile</a>
        </li>
        <li>
          <a class="dropdown-item" href="#"><i class="bi bi-wallet2 me-2"></i> Your Accounts</a>
        </li>
        <li>
          <a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i> Settings</a>
        </li>
        <li><hr class="dropdown-divider" /></li>
        <li>
          <a class="dropdown-item text-danger" href="{{ url_for('logout') }}"><i class="bi bi-box-arrow-right me-2"></i> Sign out</a>
        </li>
      </ul>
    </div>
  </div>
</header>

<main class="p-4">
  <div class="row g-4">
    <div class="col-xl-8">
      <div class="card glass-card p-4 mb-4">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <div>
            <p class="card-label mb-1">Total Amount Set</p>
            <h2 class="fw-bold text-fms-blue">UGX {{ "{:,.0f}".format(total_balance) }}</h2>
          </div>
          <button class="btn btn-fms rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#adjustBudgetModal"><i class="bi bi-pencil-square me-2"></i>Adjust Budget</button>
        </div>

        <hr class="opacity-10" />

        <div class="p-3 bg-light rounded-4 border-0 mt-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="text-muted small fw-bold text-uppercase" style="font-size: 0.65rem; letter-spacing: 0.5px">Currency Converter (For a few other countries)</span>
            <select class="form-select form-select-sm border-0 bg-white shadow-sm w-auto rounded-3 fw-bold" id="global-currency-picker" onchange="convertLive()" style="font-size: 0.75rem">
              <option value="USD" selected>USD</option>
              <option value="EUR">EUR</option>
              <option value="GBP">GBP</option>
              <option value="KES">KES</option>
            </select>
          </div>
          <div class="d-flex align-items-center">
            <div class="icon-box-sm bg-primary-subtle text-primary rounded-circle me-2 d-flex align-items-center justify-content-center" style="width: 32px; height: 32px">
              <i class="bi bi-globe" style="font-size: 0.9rem"></i>
            </div>
            <h4 class="fw-bold mb-0" id="converted-display" style="font-size: 1.25rem">Calculating...</h4>
          </div>
        </div>

        <p class="small text-muted mt-3 mb-0"><i class="bi bi-info-circle me-1"></i> This amount is reflected across your entire dashboard.</p>
      </div>

      <div class="card glass-card p-4 border-0 mb-4" style="border-radius: 28px">
        <h5 class="fw-bold mb-4" style="font-style: normal; color: #1a1d1f">Category Allocations</h5>
        <div class="accordion accordion-flush" id="categoryAccordion">
          {% for key, data in categories.items() %}
          <div class="accordion-item border-0 mb-3 bg-light" style="border-radius: 20px; overflow: hidden">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed px-4 py-4 bg-white" type="button" data-bs-toggle="collapse" data-bs-target="#group-{{ key }}" style="box-shadow: none; border-radius: 20px">
                <div class="d-flex flex-column w-100">
                  <div class="d-flex align-items-center justify-content-between mb-3">
                    <div class="d-flex align-items-center">
                      <div class="icon-box me-3 shadow-sm d-flex align-items-center justify-content-center" style="background: {{ data.color }}26 !important; color: {{ data.color }} !important; width: 48px; height: 48px; border-radius: 14px;">
                        <i class="bi {{ data.icon }} fs-4"></i>
                      </div>
                      <div>
                        <h6 class="fw-bold mb-0 text-dark">{{ data.display_name }}</h6>
                        <small class="text-muted" style="font-size: 0.7rem">AGGREGATED EXPENSES</small>
                      </div>
                    </div>
                    <div class="text-end">
                      <h6 class="fw-bold text-primary mb-0">UGX {{ "{:,.0f}".format(data.total | float) }}</h6>
                      <small class="text-muted fw-bold" style="font-size: 0.65rem">TOTAL SPENT</small>
                    </div>
                  </div>
                  <div class="progress-wrapper">
                    <div class="progress" style="height: 10px; border-radius: 10px; background: #f0f2f5">
                      {% set percent = (data.total / total_balance * 100)|round(1) if total_balance > 0 else 0 %}
                      <div class="progress-bar" role="progressbar" style="width: {{ percent if percent <= 100 else 100 }}%; background-color: {{ data.color }};"></div>
                    </div>
                    <div class="d-flex justify-content-between mt-2">
                      <small class="fw-bold text-muted text-uppercase" style="font-size: 0.65rem; letter-spacing: 0.5px"> Impact on Wallet </small>
                      <small class="fw-bold text-primary" style="font-size: 0.7rem"> {{ percent }}% OF TOTAL FUNDS </small>
                    </div>
                  </div>
                </div>
              </button>
            </h2>
            <div id="group-{{ key }}" class="accordion-collapse collapse" data-bs-parent="#categoryAccordion">
              <div class="accordion-body px-4 py-3 border-top border-light">
                {% for expense in data.expense_list %}
                <div class="d-flex justify-content-between align-items-center mb-3" data-expense-id="{{ expense.id }}">
                  <div class="d-flex align-items-center">
                    <i class="bi bi-dot fs-4" style="color: {{ data.color }}"></i>
                    <span class="small fw-bold text-muted">{{ expense.title }}</span>
                  </div>
                  <div class="d-flex align-items-center gap-3">
                    <span class="small fw-bold text-dark">UGX {{ "{:,.0f}".format(expense.amount) }}</span>
                    <button class="btn btn-link text-danger p-0" onclick="deleteExpense('{{ expense.id }}')">
                      <i class="bi bi-trash-fill small"></i>
                    </button>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <div class="col-xl-4">
      <h5 class="fw-bold mb-3">Export Records</h5>
      <div class="card glass-card p-0 overflow-hidden">
        <div class="p-4 border-bottom bg-light-subtle">
          <p class="text-muted small mb-0">Generate a professional transaction receipt based on your capital of <strong>UGX {{ "{:,.0f}".format(total_balance) }}</strong>.</p>
        </div>
        <div class="p-4">
          <form id="statementForm">
            <div class="mb-3">
              <label class="form-label small fw-bold text-muted">REPORT TYPE</label>
              <select class="form-select border-0 bg-light rounded-4" id="reportType" onchange="updatePickerVisibility()">
                <option value="weekly">Weekly Statement</option>
                <option value="monthly" selected>Monthly Statement</option>
                <option value="yearly">Yearly Summary</option>
              </select>
            </div>
            <div class="mb-3 d-none" id="weeklyGroup">
              <label class="form-label small fw-bold text-muted">SELECT DATE IN WEEK</label>
              <input type="date" class="form-control border-0 bg-light rounded-4" id="weekPicker" />
            </div>
            <div class="mb-3" id="monthlyGroup">
              <label class="form-label small fw-bold text-muted">SELECT MONTH</label>
              <input type="month" class="form-control border-0 bg-light rounded-4" id="monthPicker" value="2026-01" />
            </div>
            <div class="mb-4 d-none" id="yearlyGroup">
              <label class="form-label small fw-bold text-muted">SELECT YEAR</label>
              <select class="form-select border-0 bg-light rounded-4" id="yearPicker">
                <option value="2026">2026</option>
                <option value="2025">2025</option>
              </select>
            </div>
            <button type="button" onclick="generateReceipt()" class="btn btn-fms w-100 fw-bold rounded-4 py-2"><i class="bi bi-printer me-2"></i>Generate Receipt</button>
          </form>
        </div>
      </div>

      <h5 class="fw-bold mb-3 mt-4">Financial Allocations</h5>
      <div class="card glass-card border-0 shadow-sm" style="border-radius: 28px; overflow: hidden">
        {% set total_allocated = categories.values() | map(attribute='total') | sum %} {% set buffer = total_balance - total_allocated %} {% set usage_pct = (total_allocated / total_balance * 100) if total_balance > 0 else 0 %}

        <div class="p-4 {% if buffer < 0 %}bg-danger-subtle text-danger{% else %}bg-primary-subtle text-primary{% endif %}">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <small class="text-uppercase fw-bold opacity-75" style="font-size: 0.65rem; letter-spacing: 1px">Unallocated Funds</small>
              <h3 class="fw-bold mb-0">UGX {{ "{:,.0f}".format(buffer) }}</h3>
            </div>
            <div class="icon-box bg-white rounded-circle d-flex align-items-center justify-content-center shadow-sm" style="width: 48px; height: 48px">
              <i class="bi {% if buffer < 0 %}bi-exclamation-triangle-fill{% else %}bi-shield-check{% endif %} fs-4"></i>
            </div>
          </div>
        </div>

        <div class="p-4 bg-white">
          <div class="d-flex justify-content-between mb-2">
            <span class="small text-muted fw-bold">Budget Utilization</span>
            <span class="small fw-bold">{{ usage_pct | round(1) }}%</span>
          </div>
          <div class="progress mb-3" style="height: 8px; border-radius: 10px; background: #f0f2f5">
            <div class="progress-bar {% if usage_pct > 100 %}bg-danger{% else %}bg-primary{% endif %}" style="width: {{ usage_pct if usage_pct <= 100 else 100 }}%"></div>
          </div>

          <div class="p-3 rounded-4 bg-light border-0">
            <div class="d-flex justify-content-between mb-1">
              <small class="text-muted">Total Budgeted</small>
              <small class="fw-bold">UGX {{ "{:,.0f}".format(total_allocated) }}</small>
            </div>
            <div class="d-flex justify-content-between">
              <small class="text-muted">Total Capital</small>
              <small class="fw-bold">UGX {{ "{:,.0f}".format(total_balance) }}</small>
            </div>
          </div>

          {% if buffer < 0 %}
          <div class="mt-3 p-2 bg-danger-subtle rounded-3 text-center">
            <small class="fw-bold text-danger" style="font-size: 0.7rem"> <i class="bi bi-info-circle-fill me-1"></i> Over-budget by UGX {{ "{:,.0f}".format(buffer | abs) }} </small>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="adjustBudgetModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg" style="border-radius: 35px; background: #e9ecef; overflow: hidden">
        <div id="balance-setup-view" class="p-5">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="fw-bold mb-0" style="color: #1a1d1f; font-size: 1.3rem">Adjust Budget</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="text-center">
            <label class="small fw-bold text-muted d-block mb-3 text-uppercase" style="letter-spacing: 1.5px; font-size: 0.7rem">Current Balance</label>
            <div class="d-flex align-items-center justify-content-center gap-4">
              <button class="btn btn-link text-muted p-0" onclick="adjustValue(-25000)" style="text-decoration: none"><i class="bi bi-dash fs-2"></i></button>
              <input type="number" id="newBalanceInput" class="form-control text-center fw-bold border-0 bg-white" value="{{ total_balance }}" style="width: 200px; height: 60px; border-radius: 18px; font-size: 1.5rem" />
              <button class="btn btn-link text-muted p-0" onclick="adjustValue(25000)" style="text-decoration: none"><i class="bi bi-plus fs-2"></i></button>
            </div>
            <div class="form-check form-switch d-flex align-items-center justify-content-center gap-3 my-4 p-0">
              <input class="form-check-input ms-0" type="checkbox" id="resetToggle" style="width: 45px; height: 22px; cursor: pointer" />
              <label class="form-check-label text-danger fw-bold" for="resetToggle">Reset all expenses & cards?</label>
            </div>
            <button class="btn btn-fms w-100 py-3 fw-bold rounded-4 shadow-sm" onclick="checkResetFlag()" style="background: #0000ff !important">Update Balance</button>
          </div>
        </div>

        <div id="reset-confirm-view" class="d-none p-5 text-center">
          <div class="bg-danger-subtle text-danger rounded-circle d-inline-flex p-4 mb-3"><i class="bi bi-exclamation-triangle-fill fs-1"></i></div>
          <h3 class="fw-bold text-dark">Clear All Data?</h3>
          <p class="text-muted mb-4">This will wipe your history. Are you sure?</p>
          <div class="d-flex gap-3">
            <button class="btn btn-light rounded-pill fw-bold flex-grow-1 py-3" onclick="toggleResetConfirm(false)">Go Back</button>
            <button class="btn btn-danger rounded-pill fw-bold flex-grow-1 py-3" onclick="submitBudgetAdjustment()">Clear All</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
  // 1. DATA AND STATE
  // We use the backend rates if available, otherwise fallback to manual rates
  const backendRates = JSON.parse('{{ rates | tojson | safe if rates else "{}" }}');
  const manualRates = { USD: 0.00027, EUR: 0.00025, GBP: 0.00021, KES: 0.039 };

  // Choose backend rates first, then fallback
  const allRates = Object.keys(backendRates).length > 0 ? backendRates : manualRates;
  const ugxBalance = Number("{{ total_balance | safe }}");

  // 2. CURRENCY CONVERTER
  function convertLive() {
    const selectedCurrency = document.getElementById("global-currency-picker").value;
    const rate = allRates[selectedCurrency] || 0;
    const convertedAmount = ugxBalance * rate;

    const formatter = new Intl.NumberFormat("en-US", {
      style: "currency",
      currency: selectedCurrency,
      minimumFractionDigits: 2,
    });

    const display = document.getElementById("converted-display");
    if (display) display.innerText = formatter.format(convertedAmount);
  }

  // 3. DATE & TIME UPDATER
  function updateDateTime() {
    const now = new Date();
    const dayEl = document.getElementById("current-day");
    const dateEl = document.getElementById("current-date");

    if (dayEl) dayEl.textContent = now.toLocaleDateString("en-US", { weekday: "long" }).toUpperCase();
    if (dateEl) dateEl.textContent = now.toLocaleDateString("en-US", { month: "short", day: "2-digit", year: "numeric" });
  }

  // 4. BUDGET ADJUSTMENT LOGIC
  function adjustValue(amount) {
    const input = document.getElementById("newBalanceInput");
    if (input) input.value = Math.max(0, parseInt(input.value || 0) + amount);
  }

  function checkResetFlag() {
    if (document.getElementById("resetToggle").checked) {
      document.getElementById("balance-setup-view").classList.add("d-none");
      document.getElementById("reset-confirm-view").classList.remove("d-none");
    } else {
      submitBudgetAdjustment();
    }
  }

  function toggleResetConfirm(show) {
    document.getElementById("balance-setup-view").classList.toggle("d-none", show);
    document.getElementById("reset-confirm-view").classList.toggle("d-none", !show);
  }

  function submitBudgetAdjustment() {
    const balance = document.getElementById("newBalanceInput").value;
    const shouldReset = document.getElementById("resetToggle").checked;
    fetch("/update_balance", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ balance: balance, should_reset: shouldReset }),
    })
      .then((res) => res.json())
      .then((data) => (data.status === "success" ? location.reload() : alert("Error: " + data.message)));
  }

  // 5. EXPENSE DELETION
  function deleteExpense(id) {
    if (!confirm("Delete this expense? Your balance will be reimbursed.")) return;
    fetch(`/delete_expense/${id}`, { method: "DELETE" })
      .then((res) => res.json())
      .then((data) => (data.status === "success" ? location.reload() : alert("Error: " + data.message)));
  }

  // 6. REPORT GENERATION
  function updatePickerVisibility() {
    const type = document.getElementById("reportType").value;
    document.getElementById("weeklyGroup").classList.toggle("d-none", type !== "weekly");
    document.getElementById("monthlyGroup").classList.toggle("d-none", type !== "monthly");
    document.getElementById("yearlyGroup").classList.toggle("d-none", type !== "yearly");
  }

  function generateReceipt() {
    const type = document.getElementById("reportType").value;
    let period = type === "weekly" ? document.getElementById("weekPicker").value : type === "monthly" ? document.getElementById("monthPicker").value : document.getElementById("yearPicker").value;

    if (!period) return alert("Please select a valid time period.");
    window.open(`/print_receipt?type=${type}&period=${period}`, "_blank");
  }

  // INITIALIZE EVERYTHING ON LOAD
  window.addEventListener("DOMContentLoaded", () => {
    updateDateTime();
    convertLive();
    setInterval(updateDateTime, 60000);
  });
</script>
{% endblock %}
